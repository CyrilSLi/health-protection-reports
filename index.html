<!DOCTYPE html>
<html lang="en">
<head>
    <title>MB Health Protection Reports Map</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1/dist/leaflet.min.css">
    <script src="data.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1/dist/leaflet.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/split.js@1/dist/split.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/brython@3/brython.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/brython@3/brython_stdlib.min.js"></script>
    <style>
        * {
            touch-action: manipulation;
            margin: 0px;
            padding: 0px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            font-weight: normal;
            border: none;
        }
        body {
            height: 100dvh;
            display: flex;
        }
        #map {
            flex: 1;
        }
        .health-icon {
            width: 48px !important;
            height: 48px !important;
            margin-left: -16px !important;
            margin-top: -16px !important;
            text-align: center;
            border: 3px solid black;
            border-radius: 12px;
        }
        .health-icon > i {
            font-size: 32px;
            color: white;
            margin: auto;
        }
        .closures-icon {
            background-color: #f0b000;
        }
        .convictions-icon {
            background-color: #e00000;
        }
        .pastclosures-icon {
            background-color: #705000;
        }
        .pastconvictions-icon {
            background-color: #800000;
        }
        
        
    </style>
</head>
<body onload="brython(0)">
    <noscript>
        <p style = "margin: 20px; font-size: 20px; color: black;">JavaScript is required to use this website.</p>
    </noscript>
    <script type="text/python">
        from browser import ajax, document, window

        icon_divs, icons = (
            ('<i class="bi bi-fork-knife"></i>', "food"),
            ('<i class="bi bi-life-preserver"></i>', "pool"),
            ('<i class="bi bi-pin-angle-fill"></i>', "other")
        ), {}
        for (html, name) in icon_divs:
            for status in ("closures", "convictions", "pastclosures", "pastconvictions"):
                icons [f"{name}_{status}"] = window.L.divIcon({
                    "html": html,
                    "className": f"health-icon {status}-icon",
                })

        map = window.L.map ("map", {
            "center": [49.90, -97.14],
            "zoom": 11
        })

        timestamp = round ((window.Date.now () / 1000) - window.Date.new ().getTimezoneOffset () * 60)
        print (timestamp)
        for i in window.healthData:
            for j in window.healthData [i] ["items"]:
                if "maps" not in j:
                    continue
                if "end" in j and j ["end"] < timestamp:
                    status = "past"
                else:
                    status = ""
                if "food service establishment" in j ["type"].lower ():
                    icon = icons [f"food_{status}{i}"]
                elif "pool" in j ["type"].lower ():
                    icon = icons [f"pool_{status}{i}"]
                else:
                    icon = icons [f"other_{status}{i}"]
                window.L.marker ([j ["maps"] ["lat"], j ["maps"] ["lon"]], {
                    "icon": icon
                }).addTo (map).bindPopup (j ["name"])

        window.L.tileLayer ("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
            "attribution": "&copy; <a href = 'https://www.openstreetmap.org/copyright'>OpenStreetMap</a> contributors",
            "maxZoom": 19
        }).addTo (map)
        window.console.log (window.healthData)
    </script>
    <div id="map"></div>
    <div id="sidebar">
    </div>
</body>
</html>
